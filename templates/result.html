<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Financial Summary</title>
  <style>
    table { border-collapse: collapse; width: 80%; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: right; }
    th { background: #f2f2f2; }
    td:first-child, th:first-child { text-align: left; }
    .ai-summary { font-style: italic; border-top: 1px solid #ccc; padding-top: 1rem; }
  </style>
</head>
<body>

  {# ← Flashed error messages,to show any flash() messages from your Flask route #}
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul style="color: red; list-style: none; padding: 0;">
        {% for msg in messages %}
          <li>{{ msg }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <h2>CSV Data Summary</h2>
  <table>
    <thead>
      <tr>
        <th>Company</th>
        <th>Year</th>
        <th>Line Item</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
      {% for row in summary %}
      <tr>
        <td>{{ row['Company'] }}</td>
        <td>{{ row['Year'] }}</td>
        <td>{{ row['LineItem'] }}</td>
        <td>{{ row['Value']|currency }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {# ——— AI Analysis Section ——— #}
  {% if ai_text %}
    <div class="ai-summary">
      <h3>AI Analysis</h3>
      <p>{{ ai_text }}</p>

      <!-- ↓↓↓ Download PDF form inserted here ↓↓↓ -->
      <form action="{{ url_for('download_pdf') }}" method="post">
        <!-- single-quote wrapper so the inner JSON (with its " marks) survives intact -->
        <input type="hidden" name="summary" value='{{ summary | tojson | safe }}'>
        <!-- ai_text is just plain text -->
        <input type="hidden" name="ai_text" value="{{ ai_text }}">
        <!-- new: ship the chart PNG as a base64 string -->
        <input type="hidden" name="chart_data" value="{{ chart_data }}">
        <button type="submit">Download as PDF</button>
      </form>
    </div>  {# <-- close .ai-summary div #}

  {% else %}
    <p class="ai-summary">
      <span style="color:red;">
        No AI insight was generated. Please check your API settings.
      </span>
    </p>
  {% endif %}

  {# ——— Financial Chart ——— #}
  {% if fig_json %}
    <div style="margin-top:1.5em;">
      <h3>Revenue vs Net Income — interactive</h3>
      <div id="plotly-chart" style="width:100%;max-width:1000px;height:420px;"></div>
    </div>

    <!-- Plotly CDN (loads once on this page) -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script>
      // `fig_json` is a JSON string generated with PlotlyJSONEncoder in Flask.
      // We embed it as a real JS object (no quotes) using `|safe`.
      const fig = {{ fig_json | safe }};
      const config = { responsive: true, displaylogo: false };
      Plotly.newPlot('plotly-chart', fig.data, fig.layout || {}, config);
    </script>

  {% elif chart_data %}
    {# Fallback to the static PNG if we don't have Plotly JSON #}
    <div style="margin-top:1.5em;">
      <h3>Revenue vs Net Income (static)</h3>
      <img
        src="data:image/png;base64,{{ chart_data }}"
        alt="Bar chart of revenue vs net income"
        style="max-width:100%;height:auto;border:1px solid #ccc;"
      />
    </div>
  {% endif %}

  <p><a href="{{ url_for('index') }}">Upload another file</a></p>
</body>
</html>